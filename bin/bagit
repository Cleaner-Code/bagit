#!/usr/bin/env ruby

require 'bagit'
require 'docopt'

doc = <<DOCOPT
BagIt.

Usage: 
  #{__FILE__} [-f <file>...] [-t <tagfile>...] PATH
  #{__FILE__} -D [-f <file>...] [-t <tagfile>...] PATH
  #{__FILE__} -r [-t <tagfile>...] PATH
  #{__FILE__} --validate [-o] PATH 
  #{__FILE__} --manifest [-T] PATH
  #{__FILE__} --list [--tags | --all] PATH 
  #{__FILE__} -h | --version

Options:
  -h --help      Show this help screen.
  --version      Show version.
  -f <file>      File to add to/delete from bag. Repeatable.
  -t <tag_file>  Tag (metadata) file to add to/delete/remove from bag. Repeatable.
  -D --delete    Delete data (-f) and/or tag (-t) file.
  -r --remove    Remove tag file from manifest. File remains in bag as unmanifisted.
  --manifest     Force generation/update of manifest files.
  --T            Force regeneration of tag manifest files.
  -o --oxum      Validate against oxum only (quick validate).
  --tags         List tag files.
  --all          List all data and tag files.

DOCOPT

begin
  opts = Docopt::docopt(doc, version: 'BagIt 0.3.0')
  
  bag = BagIt::Bag.new(opts['PATH'])

  #####################################
  # commands that don't alter the bag #
  #####################################
  if opts['--validate']
    if opts['--oxum']
      puts bag.valid_oxum?.to_s
    else
      puts bag.valid?.to_s
    end
    # validation commands MUST NOT change manifest or bag-info files
    exit
  end

  if opts['--list']
    files = bag.bag_files
    if opts['--tags']
      files = bag.tag_files
    elsif opts['--all']
      files = bag.bag_files + bag.tag_files
    end
    files.each { |f| puts f }
    # quit here, too
    exit
  end


  ######################################
  # commands that may cause data loss! #
  ######################################

  #TODO: implement delete for data and tag files; remove for tag files.

  # handle add/delete bag data files
  unless opts['-f'].nil? 
    #TODO: add files in nested directories
    opts['-f'].each { |datafile|
      begin
        bag.add_file(File.basename(datafile), datafile)
      rescue Exception => e
        puts "Failed to add bag file: #{e.message}"
      end
    }  
  end

  # handle adding tag files
  unless opts['-t'].nil? 
    #TODO: add files in nested directories
    opts['-t'].each { |tagfile|
      begin
        bag.add_tag_file(File.basename(tagfile), tagfile)
      rescue Exception => e
        puts "Failed to add tag file: #{e.message}"
      end
    }
  end

  # if we haven't quit yet, we need to re-manifest
  # only do tags if tag files have been explictly added/removed or it is explictly called 
  bag.tagmanifest! if opts['-T'] or not opts['-t'].nil?
  bag.manifest!

rescue Docopt::Exit => e
  puts e.message
end

